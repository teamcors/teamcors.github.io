---
title: scale-up과 scale-out이란?
date: 2023-07-26
tags:
  - Topic of the week
---
## 트래픽이란?
서버에 발생하는 Request이다.<br>
사용자가 많아지면 서버에는 많은 HTTP request가 발생하고, 이에따라 Request가 많아졌다는 것은 트래픽이 높아졌다는 의미이다.

## 그럼 서버는 어떻게 터지나?
<strong>서버</strong>라는 것은 외부로부터 들어오는 <strong>요청을 받아 처리해주고 응답을 주는 프로그램이 돌아가고있는 컴퓨터다.</strong><br>
즉, 서버 또한 처리 속도와 한계가 CPU, 메모리, 저장장치에 영향을 받아 한계가 있다는 것이다.

![Rocket launch](/media/tomcat_access.jpeg)

request는 queue를 통해 thread pool에 할당되는데, maxThreads(Thread pool size)를 초과하는 요청은 queue에서 대기한다. 이는 문제 상황이 발생했을 확률이 높다는 뜻으로 운영체제에서 요청을 거부하고 대기하는데, 언제까지고 기다릴 수는 없으므로 일정 시간이 지나면 실패로 간주한다.(타임아웃)<br>
이와 같은 현상이 지속적으로 발생하면 서버의 지연시간이 기하급수적으로 증가하게 되고 트래픽 장애가 발생하는 것이다.

## 처리하는 방법
대용량 트래픽으로 서버가 터지는 이유는 아직 처리되지 못한 요청이 쌓이고 쌓이다가 부하를 견디지 못하고 다운되는 것이므로, 단순히 생각해서 요청을 충분히 빠르게 처리하면 된다.

## Scale-up(수직 확장)

![Rocket launch](/media/scale-up.png)

서버의 CPU, RAM(Memory), HDD/SDD(Storage) 등을 추가하거나 더 높은 사양으로 업그레이드 하는 것이다.<br>
대용량 트래픽 처리를 위한 scale-up을 고려하는 경우 <strong>기억장치(HDD/SDD)의 처리 속도 업그레이드를 고려해야한다.</strong>

![Rocket launch](/media/cpu-sdd.png)

왜냐? 아무리 CPU의 연산 속도가 뛰어나도 기억장치의 데이터 접근 속도가 느리면 결과적으로 요청의 처리속도가 느리기 때문이다.

scale-up은 기존 서버의 사양만 올리는 것으로 비교적 쉽게 교체할 수 있으며, 추가적인 네트워크 연결이 필요하지 않다는 장점이 있다.<br>
하지만 하드웨어를 교체하는 것에 있어서 허용 범위가 있기에 성능 향상에 한계가 있으며, 이에따른 비용 부담이 크다.<br>
또한 분산처리가 아니기에 하나의 서버에 많은 양의 트래픽을 처리하게 되는데, 서버에 장애가 발생할 경우 큰 타격을 얻어 서버 복구 전까지 서비스를 중단해야하는 경우가 도래한다.<br>

## Scale-out(수평 확장)
![Rocket launch](/media/scale-out.png)

서버를 여러 대 추가하여 물리적으로 확장하는 방법이다.<br>
클라우드를 이용하면 Auto Scaling이라는 기술(자원 사용량을 모니터링 해서 자동으로 서버 증설을 해주는 기능)이 있는데, 이때 사용되는 기술이 scale-out이다.<br>
주로 예상되는 대용량 트래픽(새해, 크리스마스, 추석 등)에 사용되어, 필요한 만큼 도입했다가 줄이는 방식으로 사용하여 비용을 절감 할 수 있다.<br>
scale-out은 scale-up과 달리 하드웨어의 한계에 봉착하지 않으며 서버를 확장할 수 있다. 또한 하나의 서버에 장애가 생겼을 때, 다른 서버를 사용하면 되므로 고가용성이라는 장점이 있다.<br><br>
그렇지만 고가용성이라는 장점은 장애가 발생한 서버를 인지하고 다른 서버로 연결해주는 '무언가'가 있어야만 해결되는 것이다.<br>
만약 그 무언가가 없다면.. 특정 서버에 장시간의 처리가 필요한 요청이 몰릴 때 해당 서버(A)만 터지게 될 것이고, 운 없게도 해당 서버(A)로 요청을 보낸 사용자들은 서버가 다운되었다고 생각할 것이다. <br>반면 요청이 몰리지 않은 다른 서버(B)에 접근한 사용자들은 서비스를 이용할 수 있게 된다. 이러한 상황이 티켓팅에 발생했다면 큰 문제일 것이다.

이런 문제를 해결하기 위한 기술이 <strong>로드밸런싱</strong>이다.


## Load balancing(부하 분산)

로드밸런서를 통해 각 서버의 남은 큐의 크기, 이미 축적된 요청들의 예상 처리 시간등을 고려해 최적의 서버로 요청들을 분배하여 특정 서버에만 부하가 가중되는 것을 방지할 수 있다. 또한 트래픽을 모니터링을 통해 악성 콘텐츠를 차단한다.

로드 밸런싱 알고리즘은 정적 로드 밸런싱과 동적 로드 밸런싱으로 나뉜다.

<strong>정적 로드밸런싱</strong>은 서버 상태에 따라 트래픽을 분산하는 것이 아니라 <strong>정해진 규칙에 따라 분산한다.</strong>
#### 1. 라운드 로빈 방식

request가 들어온 순서대로 서버에 돌아가며 배분된다. <br>
이 방식은 모든 서버의 처리 능력이 동일 할 때와 서버와의 연결이 길지 않을 때 적합하다.

#### 2. 가중 기반 라운드 로빈 방식

각 서버에 가중치를 부여하여 가중치에 따라 요청을 우선적으로 배분한다. 가중치가 높을 수록 서버는 처리할 요청이 많아진다.<br>
서버의 트래픽 처리 능력이 상이 할 경우 적합하다.

#### 3. IP 해시 방식

클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리한다.<br>
IP를 해싱하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장한다.


<strong>동적 로드밸런싱</strong>은 정적 로드밸런싱과 달리 서버 상태를 검사하고 <strong>서버 상태에 따라 트래픽을 분산한다.</strong><br><br>

#### 1. 최소 연결 방식

요청이 들어온 시점에 연결 상태가 가장 적은 서버에 트래픽을 우선적으로 분배한다.<br>
여러 대의 서버가 동일한 처리 능력을 가진 경우와 서버에 분배된 트래픽이 일정하지 않은 경우 적합하다.

#### 2. 가중치 기반 최소 연결 방식

최소 연결 방식의 한 부분으로 각각 서버에 성능 가중치를 할당하여, 가중치와 연결 상태에 따라 요청을 분배한다.<br>
서버의 트래픽 처리 능력이 상이 할 경우 적합하며, 만약 처리 능력이 동일할 경우 최소 연결 방식과 알고리즘이 동일하다.

#### 3. 최소 응답 시간 방식

서버의 연결 상태와 요청을 처리하고 응답을 전송할 때까지의 시간을 고려하여 트래픽을 분배한다.<br>
가장 적은 연결 상태와 가장 짧은 응답 시간을 보이는 서버에 우선적으로 분배한다.



처음 로드밸런싱을 설명할 때 <strong>'로드밸런서'</strong>라는 단어를 사용했다. 로드밸런서란 부하(=로드)를 분산(=밸런싱)해주는 장치 또는 기술을 통칭하는데, 가장 L4장비와 L7장비가 가장 활용도가 높다. 각각 Layer4(전송 계층)과 Layer7(응용 계층)에서 부하를 분산한다.<br><br>

![Rocket launch](/media/L4.jpg)

<strong>L4 로드 밸런서</strong>는 네트워크 계층(IP)나 전송 계층(TCP, UDP)를 기준으로 로드밸런싱 알고리즘을 통해 부하를 분산한다.<br>즉, 요청 서비스의 종류와 상관 없이 최적의 서버로 분배하는 것이다.

![Rocket launch](/media/L7.jpg)

<strong>L7 로드 밸런서</strong>는 응용 계층(HTTP, FTP, SMTP)에서 로드밸런싱을 하기 때문에, IP나 Port 외에도 URI, Http Header, Cookie 등의 사용자 요청 기준으로 분배가 가능하다.<br>서비스를 기준으로 서버를 분리하여 운영하고 요청을 각각 서버에 분산할 수 있다.<br>L4와 달리 데이터를 분석하여 처리하기 때문에 악의적이거나 비정상적인 트래픽을 필터링 할 수 있는 장점이 있으나, 클라이언트가 로드 밸런서와 인증서를 공유해야하기 때문에 로드 밸런서를 통해 공격자가 사용자 데이터에 접근할 수 있는 보안 상의 위험성도 존재한다.


## 마치며
트래픽은 무엇인지 또 대용량 트래픽을 처리하는 scale-up과 scale-out에 대해 알아보면서 로드 밸런싱까지 알아보았다.<br>
비교하며 알아보면 좋은 내용들이기에 한 눈에 비교할 수 있도록 아래의 사진을 첨부하니 참고하면 좋을 것 같다.
![Rocket launch](/media/df-scale-up-scale-out.png)
![Rocket launch](/media/L4-L7.png)